{"version":3,"names":["React","useCallback","useEffect","useMemo","Platform","StyleSheet","View","Animated","useAnimatedStyle","useSharedValue","withTiming","CacheManager","AnimatedImage","Image","AnimatedView","defaultProps","onError","useIsComponentMounted","isMounted","useRef","current","useStateIfMounted","initialState","isComponentMounted","state","setState","useState","newSetState","value","CachedImage","props","error","setError","uri","setUri","undefined","source","propsSource","currentSource","setCurrentSource","animatedImage","animatedThumbnailImage","animatedLoadingImage","imageSourceStyle","opacity","thumbnailSourceStyle","animatedLoadingImageStyle","load","catch","resetAnimations","maxAge","noCache","options","path","get","getPath","nativeEvent","Error","e","onThumbnailLoad","duration","thumbnailAnimationDuration","config","onImageError","onImageLoad","onLoad","sourceAnimationDuration","accessibilityRole","accessibilityRoleThumbnail","accessibilityRoleLoadingSource","accessibilityHint","accessibilityHintLoadingImage","accessibilityHintThumbnail","accessibilityLabel","accessibilityLabelLoadingImage","accessibilityLabelThumbnail","blurRadius","loadingImageComponent","LoadingImageComponent","loadingImageStyle","style","loadingSource","resizeMode","testID","thumbnailSource","rest","isImageReady","imageSource","OS","styles","container","onLoadEnd","imageStyle","create","backgroundColor","bottom","left","position","right","top","alignItems","alignSelf","justifyContent"],"sources":["CachedImage.tsx"],"sourcesContent":["import React, {\n  Dispatch,\n  SetStateAction,\n  useCallback,\n  useEffect,\n  useMemo,\n} from 'react';\nimport {\n  ImageLoadEventData,\n  NativeSyntheticEvent,\n  Platform,\n  StyleSheet,\n  View,\n} from 'react-native';\nimport Animated, {\n  useAnimatedStyle,\n  useSharedValue,\n  withTiming,\n} from 'react-native-reanimated';\n\nimport CacheManager from './CacheManager';\nimport { ImageProps, IProps } from './types';\n\nconst AnimatedImage = Animated.Image;\nconst AnimatedView = Animated.View;\n\nconst defaultProps = {\n  onError: () => {},\n};\n\nfunction useIsComponentMounted() {\n  const isMounted = React.useRef(false);\n  // @ts-ignore\n  useEffect(() => {\n    isMounted.current = true;\n    return () => (isMounted.current = false);\n  }, []);\n  return isMounted;\n}\n\nfunction useStateIfMounted<S>(\n  initialState: S | (() => S)\n): [S, Dispatch<SetStateAction<S>>] {\n  const isComponentMounted = useIsComponentMounted();\n  const [state, setState] = React.useState(initialState);\n\n  const newSetState = useCallback(\n    value => {\n      if (isComponentMounted.current) {\n        setState(value);\n      }\n    },\n    [isComponentMounted]\n  );\n\n  return [state, newSetState];\n}\n\nconst CachedImage = (props: IProps & typeof defaultProps) => {\n  const [error, setError] = useStateIfMounted<boolean>(false);\n  const [uri, setUri] = useStateIfMounted<string | undefined>(undefined);\n  const { source: propsSource } = props;\n  const [currentSource, setCurrentSource] = React.useState<string>(propsSource);\n\n  const animatedImage = useSharedValue(0);\n\n  const animatedThumbnailImage = useSharedValue(0);\n\n  const animatedLoadingImage = useSharedValue(1);\n\n  const imageSourceStyle = useAnimatedStyle(() => {\n    return { opacity: animatedImage.value };\n  });\n\n  const thumbnailSourceStyle = useAnimatedStyle(() => {\n    return { opacity: animatedThumbnailImage.value };\n  });\n\n  const animatedLoadingImageStyle = useAnimatedStyle(() => {\n    return { opacity: animatedLoadingImage.value };\n  });\n\n  useEffect(() => {\n    if (propsSource !== uri) {\n      load(props).catch();\n    }\n    if (propsSource !== currentSource) {\n      setCurrentSource(propsSource);\n      setUri(undefined);\n      resetAnimations();\n    }\n    /* eslint-disable react-hooks/exhaustive-deps */\n  }, [propsSource, uri]);\n\n  const load = async ({\n    maxAge,\n    noCache = false,\n    onError,\n    options = {},\n    source,\n  }: ImageProps): Promise<void> => {\n    if (source) {\n      try {\n        const path = await CacheManager.get(\n          source,\n          options,\n          noCache,\n          maxAge\n        ).getPath();\n\n        if (path) {\n          setUri(path);\n          setError(false);\n        } else {\n          setError(true);\n          onError({\n            nativeEvent: { error: new Error('Could not load image') },\n          });\n        }\n      } catch (e: any) {\n        setError(true);\n        onError({ nativeEvent: { error: e } });\n      }\n    }\n  };\n\n  const resetAnimations = () => {\n    animatedLoadingImage.value = 1;\n    animatedThumbnailImage.value = 0;\n    animatedImage.value = 0;\n  };\n\n  const onThumbnailLoad = () => {\n    animatedLoadingImage.value = withTiming(0, {}, () => {\n      animatedThumbnailImage.value = withTiming(1, {\n        duration:\n          props.thumbnailAnimationDuration ||\n          CacheManager.config.thumbnailAnimationDuration,\n      });\n    });\n  };\n\n  const onImageError = (): void => setError(true);\n\n  const onImageLoad = (e: NativeSyntheticEvent<ImageLoadEventData>): void => {\n    if (props.onLoad) {\n      props.onLoad(e);\n    }\n    animatedImage.value = withTiming(1, {\n      duration:\n        props.sourceAnimationDuration ||\n        CacheManager.config.sourceAnimationDuration,\n    });\n  };\n\n  const {\n    accessibilityRole,\n    accessibilityRoleThumbnail,\n    accessibilityRoleLoadingSource,\n    accessibilityHint,\n    accessibilityHintLoadingImage,\n    accessibilityHintThumbnail,\n    accessibilityLabel,\n    accessibilityLabelLoadingImage,\n    accessibilityLabelThumbnail,\n    blurRadius,\n    loadingImageComponent: LoadingImageComponent,\n    loadingImageStyle = props.style,\n    loadingSource,\n    resizeMode,\n    style,\n    testID,\n    thumbnailSource,\n    ...rest\n  } = props;\n\n  const isImageReady = useMemo(() => !!uri, [uri, propsSource]);\n\n  const imageSource = useMemo(() => {\n    return error || !uri\n      ? loadingSource\n      : {\n          uri: Platform.OS === 'android' ? `file://${uri}` : uri,\n        };\n  }, [uri, error]);\n\n  return (\n    <View style={[styles.container, style]} testID={testID}>\n      {!isImageReady &&\n        (LoadingImageComponent ? (\n          <AnimatedView\n            style={[styles.loadingImageStyle, animatedLoadingImageStyle]}\n          >\n            <LoadingImageComponent />\n          </AnimatedView>\n        ) : (\n          <View style={[styles.loadingImageStyle]}>\n            <AnimatedImage\n              accessibilityHint={accessibilityHintLoadingImage}\n              accessibilityLabel={accessibilityLabelLoadingImage}\n              accessibilityRole={accessibilityRoleLoadingSource || 'image'}\n              accessible\n              resizeMode={resizeMode || 'contain'}\n              style={[animatedLoadingImageStyle, loadingImageStyle]}\n              // @ts-ignore\n              source={loadingSource}\n            />\n          </View>\n        ))}\n      {thumbnailSource && (\n        <AnimatedImage\n          accessibilityHint={accessibilityHintThumbnail}\n          accessibilityLabel={accessibilityLabelThumbnail}\n          accessibilityRole={accessibilityRoleThumbnail || 'image'}\n          accessible\n          blurRadius={blurRadius || CacheManager.config.blurRadius}\n          onLoad={onThumbnailLoad}\n          resizeMode={resizeMode || 'contain'}\n          source={{ uri: thumbnailSource }}\n          style={[style, thumbnailSourceStyle]}\n        />\n      )}\n      {imageSource && (\n        <AnimatedImage\n          {...rest}\n          accessibilityHint={accessibilityHint}\n          accessibilityLabel={accessibilityLabel}\n          accessibilityRole={accessibilityRole || 'image'}\n          accessible\n          onError={onImageError}\n          onLoad={onImageLoad}\n          onLoadEnd={props.onLoadEnd}\n          resizeMode={resizeMode || 'contain'}\n          // @ts-ignore\n          source={imageSource}\n          // @ts-ignore\n          style={[styles.imageStyle, imageSourceStyle]}\n        />\n      )}\n    </View>\n  );\n};\n\nconst styles = StyleSheet.create({\n  container: {\n    backgroundColor: 'transparent',\n  },\n  imageStyle: {\n    bottom: 0,\n    left: 0,\n    position: 'absolute',\n    right: 0,\n    top: 0,\n  },\n  loadingImageStyle: {\n    alignItems: 'center',\n    alignSelf: 'center',\n    bottom: 0,\n    justifyContent: 'center',\n    left: 0,\n    position: 'absolute',\n    right: 0,\n    top: 0,\n  },\n});\n\nCachedImage.defaultProps = defaultProps;\n\nexport default CachedImage;\n"],"mappings":"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"}