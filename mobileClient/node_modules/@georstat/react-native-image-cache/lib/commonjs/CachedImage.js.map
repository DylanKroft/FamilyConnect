{"version":3,"names":["AnimatedImage","Animated","Image","AnimatedView","View","defaultProps","onError","useIsComponentMounted","isMounted","React","useRef","useEffect","current","useStateIfMounted","initialState","isComponentMounted","state","setState","useState","newSetState","useCallback","value","CachedImage","props","error","setError","uri","setUri","undefined","source","propsSource","currentSource","setCurrentSource","animatedImage","useSharedValue","animatedThumbnailImage","animatedLoadingImage","imageSourceStyle","useAnimatedStyle","opacity","thumbnailSourceStyle","animatedLoadingImageStyle","load","catch","resetAnimations","maxAge","noCache","options","path","CacheManager","get","getPath","nativeEvent","Error","e","onThumbnailLoad","withTiming","duration","thumbnailAnimationDuration","config","onImageError","onImageLoad","onLoad","sourceAnimationDuration","accessibilityRole","accessibilityRoleThumbnail","accessibilityRoleLoadingSource","accessibilityHint","accessibilityHintLoadingImage","accessibilityHintThumbnail","accessibilityLabel","accessibilityLabelLoadingImage","accessibilityLabelThumbnail","blurRadius","loadingImageComponent","LoadingImageComponent","loadingImageStyle","style","loadingSource","resizeMode","testID","thumbnailSource","rest","isImageReady","useMemo","imageSource","Platform","OS","styles","container","onLoadEnd","imageStyle","StyleSheet","create","backgroundColor","bottom","left","position","right","top","alignItems","alignSelf","justifyContent"],"sources":["CachedImage.tsx"],"sourcesContent":["import React, {\n  Dispatch,\n  SetStateAction,\n  useCallback,\n  useEffect,\n  useMemo,\n} from 'react';\nimport {\n  ImageLoadEventData,\n  NativeSyntheticEvent,\n  Platform,\n  StyleSheet,\n  View,\n} from 'react-native';\nimport Animated, {\n  useAnimatedStyle,\n  useSharedValue,\n  withTiming,\n} from 'react-native-reanimated';\n\nimport CacheManager from './CacheManager';\nimport { ImageProps, IProps } from './types';\n\nconst AnimatedImage = Animated.Image;\nconst AnimatedView = Animated.View;\n\nconst defaultProps = {\n  onError: () => {},\n};\n\nfunction useIsComponentMounted() {\n  const isMounted = React.useRef(false);\n  // @ts-ignore\n  useEffect(() => {\n    isMounted.current = true;\n    return () => (isMounted.current = false);\n  }, []);\n  return isMounted;\n}\n\nfunction useStateIfMounted<S>(\n  initialState: S | (() => S)\n): [S, Dispatch<SetStateAction<S>>] {\n  const isComponentMounted = useIsComponentMounted();\n  const [state, setState] = React.useState(initialState);\n\n  const newSetState = useCallback(\n    value => {\n      if (isComponentMounted.current) {\n        setState(value);\n      }\n    },\n    [isComponentMounted]\n  );\n\n  return [state, newSetState];\n}\n\nconst CachedImage = (props: IProps & typeof defaultProps) => {\n  const [error, setError] = useStateIfMounted<boolean>(false);\n  const [uri, setUri] = useStateIfMounted<string | undefined>(undefined);\n  const { source: propsSource } = props;\n  const [currentSource, setCurrentSource] = React.useState<string>(propsSource);\n\n  const animatedImage = useSharedValue(0);\n\n  const animatedThumbnailImage = useSharedValue(0);\n\n  const animatedLoadingImage = useSharedValue(1);\n\n  const imageSourceStyle = useAnimatedStyle(() => {\n    return { opacity: animatedImage.value };\n  });\n\n  const thumbnailSourceStyle = useAnimatedStyle(() => {\n    return { opacity: animatedThumbnailImage.value };\n  });\n\n  const animatedLoadingImageStyle = useAnimatedStyle(() => {\n    return { opacity: animatedLoadingImage.value };\n  });\n\n  useEffect(() => {\n    if (propsSource !== uri) {\n      load(props).catch();\n    }\n    if (propsSource !== currentSource) {\n      setCurrentSource(propsSource);\n      setUri(undefined);\n      resetAnimations();\n    }\n    /* eslint-disable react-hooks/exhaustive-deps */\n  }, [propsSource, uri]);\n\n  const load = async ({\n    maxAge,\n    noCache = false,\n    onError,\n    options = {},\n    source,\n  }: ImageProps): Promise<void> => {\n    if (source) {\n      try {\n        const path = await CacheManager.get(\n          source,\n          options,\n          noCache,\n          maxAge\n        ).getPath();\n\n        if (path) {\n          setUri(path);\n          setError(false);\n        } else {\n          setError(true);\n          onError({\n            nativeEvent: { error: new Error('Could not load image') },\n          });\n        }\n      } catch (e: any) {\n        setError(true);\n        onError({ nativeEvent: { error: e } });\n      }\n    }\n  };\n\n  const resetAnimations = () => {\n    animatedLoadingImage.value = 1;\n    animatedThumbnailImage.value = 0;\n    animatedImage.value = 0;\n  };\n\n  const onThumbnailLoad = () => {\n    animatedLoadingImage.value = withTiming(0, {}, () => {\n      animatedThumbnailImage.value = withTiming(1, {\n        duration:\n          props.thumbnailAnimationDuration ||\n          CacheManager.config.thumbnailAnimationDuration,\n      });\n    });\n  };\n\n  const onImageError = (): void => setError(true);\n\n  const onImageLoad = (e: NativeSyntheticEvent<ImageLoadEventData>): void => {\n    if (props.onLoad) {\n      props.onLoad(e);\n    }\n    animatedImage.value = withTiming(1, {\n      duration:\n        props.sourceAnimationDuration ||\n        CacheManager.config.sourceAnimationDuration,\n    });\n  };\n\n  const {\n    accessibilityRole,\n    accessibilityRoleThumbnail,\n    accessibilityRoleLoadingSource,\n    accessibilityHint,\n    accessibilityHintLoadingImage,\n    accessibilityHintThumbnail,\n    accessibilityLabel,\n    accessibilityLabelLoadingImage,\n    accessibilityLabelThumbnail,\n    blurRadius,\n    loadingImageComponent: LoadingImageComponent,\n    loadingImageStyle = props.style,\n    loadingSource,\n    resizeMode,\n    style,\n    testID,\n    thumbnailSource,\n    ...rest\n  } = props;\n\n  const isImageReady = useMemo(() => !!uri, [uri, propsSource]);\n\n  const imageSource = useMemo(() => {\n    return error || !uri\n      ? loadingSource\n      : {\n          uri: Platform.OS === 'android' ? `file://${uri}` : uri,\n        };\n  }, [uri, error]);\n\n  return (\n    <View style={[styles.container, style]} testID={testID}>\n      {!isImageReady &&\n        (LoadingImageComponent ? (\n          <AnimatedView\n            style={[styles.loadingImageStyle, animatedLoadingImageStyle]}\n          >\n            <LoadingImageComponent />\n          </AnimatedView>\n        ) : (\n          <View style={[styles.loadingImageStyle]}>\n            <AnimatedImage\n              accessibilityHint={accessibilityHintLoadingImage}\n              accessibilityLabel={accessibilityLabelLoadingImage}\n              accessibilityRole={accessibilityRoleLoadingSource || 'image'}\n              accessible\n              resizeMode={resizeMode || 'contain'}\n              style={[animatedLoadingImageStyle, loadingImageStyle]}\n              // @ts-ignore\n              source={loadingSource}\n            />\n          </View>\n        ))}\n      {thumbnailSource && (\n        <AnimatedImage\n          accessibilityHint={accessibilityHintThumbnail}\n          accessibilityLabel={accessibilityLabelThumbnail}\n          accessibilityRole={accessibilityRoleThumbnail || 'image'}\n          accessible\n          blurRadius={blurRadius || CacheManager.config.blurRadius}\n          onLoad={onThumbnailLoad}\n          resizeMode={resizeMode || 'contain'}\n          source={{ uri: thumbnailSource }}\n          style={[style, thumbnailSourceStyle]}\n        />\n      )}\n      {imageSource && (\n        <AnimatedImage\n          {...rest}\n          accessibilityHint={accessibilityHint}\n          accessibilityLabel={accessibilityLabel}\n          accessibilityRole={accessibilityRole || 'image'}\n          accessible\n          onError={onImageError}\n          onLoad={onImageLoad}\n          onLoadEnd={props.onLoadEnd}\n          resizeMode={resizeMode || 'contain'}\n          // @ts-ignore\n          source={imageSource}\n          // @ts-ignore\n          style={[styles.imageStyle, imageSourceStyle]}\n        />\n      )}\n    </View>\n  );\n};\n\nconst styles = StyleSheet.create({\n  container: {\n    backgroundColor: 'transparent',\n  },\n  imageStyle: {\n    bottom: 0,\n    left: 0,\n    position: 'absolute',\n    right: 0,\n    top: 0,\n  },\n  loadingImageStyle: {\n    alignItems: 'center',\n    alignSelf: 'center',\n    bottom: 0,\n    justifyContent: 'center',\n    left: 0,\n    position: 'absolute',\n    right: 0,\n    top: 0,\n  },\n});\n\nCachedImage.defaultProps = defaultProps;\n\nexport default CachedImage;\n"],"mappings":"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"}